<!DOCTYPE HTML>

<html>
  <head>
    <meta charset = 'UTF-8' />
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <script type='text/javascript' src='/monkey-patch.js'></script>
    <script type='text/javascript' src='/ajax-helper.js'></script>
    <style>
      div.container { margin: 1em; }
      table th,td { text-align: left; }
      img.logo { max-width: 75px; }
    </style>
    <link rel='stylesheet' href='https://unpkg.com/purecss@0.6.1/build/pure-min.css'>
    <title>Prerender.cloud AJAX monkey patch test</title>
  </head>
  <body>
    <div class='container'>
      <img class='logo' src='/prerender-cloud-logo.svg' />
      <h1><a href='https://www.prerender.cloud/' target='_blank'>Prerender.cloud</a> AJAX monkey patch test</h1>
      <p>This is a test for an XHR and window.fetch monkey patch included by default from <a href='https://www.prerender.cloud/' target='_blank'>prerender.cloud</a>. It should be run against all major browsers.</p>
      <p>
        The monkey patch stubs GET requests with a url->payload mapping from a base64 encoded JSON object. Once an endpoint is called, it is cleared from the stub/patch.
        <br />
        The data structure looks like:
        <pre><code>{'http://example.org/ajax-endpoint': 'aGVsbG8gd29ybGQ='}</code></pre>
      </p>
      <p>
        <ul>
          <li>base64 is used because escaping JSON payloads in the DOM is confusing and hard to understand after the fact</li>
          <li>multi-byte characters are used in this test since there's <a href='https://coolaj86.com/articles/base64-unicode-utf-8-javascript-and-you/'>potential for loss with base64 encoding</a></li>
        </ul>
      </p>

      <h2>Happy path application/json</h2>
      <table class='pure-table pure-table-bordered'>
        <tr>
          <th>1st req should come from stub</th>
          <td id='xhr1-result' data-expected='from-client: I ½ ♥ 𩶘'></td>
          <td id='xhr1-check'></td>
        </tr>
        <tr>
          <th>2nd req should come from server</th>
          <td id='xhr2-result' data-expected='from-server: I ½ ♥ 𩶘'></td>
          <td id='xhr2-check'></td>
        </tr>
      </table>

      <h2>Happy path text/plain</h2>
      <table class='pure-table pure-table-bordered'>
        <tr>
          <th>1st req should come from stub</th>
          <td id='xhr1text-result' data-expected='from-client: I ½ ♥ 𩶘'></td>
          <td id='xhr1text-check'></td>
        </tr>
        <tr>
          <th>2nd req should come from server</th>
          <td id='xhr2text-result' data-expected='from-server: I ½ ♥ 𩶘'></td>
          <td id='xhr2text-check'></td>
        </tr>
      </table>

      <h2>Bad base64</h2>
      <table class='pure-table pure-table-bordered'>
        <tr>
          <th>1st req should come from server</th>
          <td id='xhr1bad-result' data-expected='from-server: I ½ ♥ 𩶘'></td>
          <td id='xhr1bad-check'></td>
        </tr>
        <tr>
          <th>2nd req should come from server</th>
          <td id='xhr2bad-result' data-expected='from-server: I ½ ♥ 𩶘'></td>
          <td id='xhr2bad-check'></td>
        </tr>
      </table>
    </div>
  </body>
</html>

<script type='text/javascript'>
  function runTests(el1, el2, endpoint, useJson) {
    getAjax(endpoint, function(res) {
      document.getElementById(el1 + '-result').innerHTML = useJson ? JSON.parse(res).text : res;

      if (document.getElementById(el1 + '-result').innerHTML === document.getElementById(el1 + '-result').getAttribute('data-expected')) {
        document.getElementById(el1 + '-check').innerHTML = "✅"
      } else {
        document.getElementById(el1 + '-check').innerHTML = "❌"
      }

      getAjax(endpoint, function(res) {
        document.getElementById(el2 + '-result').innerHTML = useJson ? JSON.parse(res).text : res;

        if (document.getElementById(el2 + '-result').innerHTML === document.getElementById(el2 + '-result').getAttribute('data-expected')) {
          document.getElementById(el2 + '-check').innerHTML = "✅"
        } else {
          document.getElementById(el2 + '-check').innerHTML = "❌"
        }
      });
    })
  }

</script>

<script type='text/javascript'>

  var originalXMLHttpRequestOpen = XMLHttpRequest.prototype.open;
  var originalXMLHttpRequestSend = XMLHttpRequest.prototype.send;

  function restore() {
    XMLHttpRequest.prototype.open = originalXMLHttpRequestOpen;
    XMLHttpRequest.prototype.send = originalXMLHttpRequestSend;
  }

  var base64Expectations = {
    dev: {
      // new Buffer(JSON.stringify({'http://localhost:8888/json1': JSON.stringify({text: 'from-client: I ½ ♥ 𩶘'})})).toString('base64')
      json: 'eyJodHRwOi8vbG9jYWxob3N0Ojg4ODgvanNvbjEiOiJ7XCJ0ZXh0XCI6XCJmcm9tLWNsaWVudDogSSDCvSDimaUg8Km2mFwifSJ9',
      // new Buffer(JSON.stringify({'http://localhost:8888/text1': 'from-client: I ½ ♥ 𩶘'})).toString('base64')
      text: 'eyJodHRwOi8vbG9jYWxob3N0Ojg4ODgvdGV4dDEiOiJmcm9tLWNsaWVudDogSSDCvSDimaUg8Km2mCJ9'
    },
    prod: {
      // new Buffer(JSON.stringify({'https://prerendercloud-ajaxmonkeypatch.herokuapp.com/json1': JSON.stringify({text: 'from-client: I ½ ♥ 𩶘'})})).toString('base64')
      json: 'eyJodHRwczovL3ByZXJlbmRlcmNsb3VkLWFqYXhtb25rZXlwYXRjaC5oZXJva3VhcHAuY29tL2pzb24xIjoie1widGV4dFwiOlwiZnJvbS1jbGllbnQ6IEkgwr0g4pmlIPCptphcIn0ifQ==',
      // new Buffer(JSON.stringify({'https://prerendercloud-ajaxmonkeypatch.herokuapp.com/text1': 'from-client: I ½ ♥ 𩶘'})).toString('base64')
      text: 'eyJodHRwczovL3ByZXJlbmRlcmNsb3VkLWFqYXhtb25rZXlwYXRjaC5oZXJva3VhcHAuY29tL3RleHQxIjoiZnJvbS1jbGllbnQ6IEkgwr0g4pmlIPCptpgifQ=='
    }
  };
  var getEnv = function() { return window.location.origin.match(/localhost/) ? 'dev' : 'prod'; };
  var getField = function(field) { return base64Expectations[getEnv()][field]; };
  base64Expectations.json = function() { return getField('json'); };
  base64Expectations.text = function() { return getField('text'); };

  /**
   * - ajaxMonkeyPatch stubs XHR GET requests with a url-> payload mapping from a base64 encoded JSON object
   *   once an endpoint is called, it is cleared from the stub
   * - looks like:
   * {
   *   'http://example.org/ajax-endpoint': 'aGVsbG8gd29ybGQ='
   * }
  **/
  (function(window){
    var host = '/'
    // when base64 is valid stringified JSON payload:
    ajaxMonkeyPatch(window, base64Expectations.json());
    runTests('xhr1','xhr2', host + 'json1', true);

    // when valid text payload
    restore();
    ajaxMonkeyPatch(window, base64Expectations.text());
    runTests('xhr1text','xhr2text', host + 'text1', false);

    // when base64 is bad
    restore();
    ajaxMonkeyPatch(window, 'invalid-base64');
    runTests('xhr1bad','xhr2bad', host + 'json1', true);
  })(window)

</script>